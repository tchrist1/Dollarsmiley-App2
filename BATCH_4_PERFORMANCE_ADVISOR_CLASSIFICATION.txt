================================================================================
BATCH 4: PERFORMANCE ADVISOR FINDINGS CLASSIFICATION
================================================================================
Date: 2026-01-15
Focus: RLS Performance and Index Optimization
Post: Security hardening + Foreign key indexes + Filter/sort indexes

================================================================================
STEP 1 — CLASSIFICATION OF REMAINING FINDINGS
================================================================================

Finding Type: auth_rls_initplan
Count: 300+ policies across 100+ tables
Level: WARN
Category: ✅ ACTIONABLE WARNING

Description:
  RLS policies call auth.uid() directly, causing re-evaluation for EACH ROW.
  This is a well-known Postgres performance issue.

Impact:
  - High impact on queries that scan many rows
  - Exponential performance degradation with table size
  - Official Supabase recommendation to fix

Fix:
  Replace: auth.uid()
  With: (select auth.uid())

Rationale:
  The subquery is evaluated ONCE per query instead of per-row.
  This is a safe, non-breaking change that only affects performance.

Actionable: YES
Risk: LOW
Priority: HIGH

--------------------------------------------------------------------------------

Finding Type: multiple_permissive_policies
Count: 50+ tables with duplicate role+action policies
Level: WARN
Category: ⚠️ ACTIONABLE WARNING (with caution)

Description:
  Multiple permissive policies exist for same role+action combination.
  Each policy must be evaluated separately, causing performance overhead.

Impact:
  - Medium impact - policies are ORed together
  - Each additional policy adds evaluation cost
  - Can be consolidated into single policy

Fix Options:
  1. Combine policies with OR logic into single policy
  2. Use restrictive policies where appropriate
  3. Leave as-is if policies serve different business purposes

Actionable: YES (case-by-case analysis required)
Risk: MEDIUM (must not change authorization logic)
Priority: MEDIUM

Examples:
  - ai_agents: "Admins can manage" + "Anyone can view active"
    → Can combine: admin check OR is_active

  - bookings: Multiple ownership checks
    → Need to analyze if consolidation changes behavior

--------------------------------------------------------------------------------

Finding Type: duplicate_index
Count: 5 tables with duplicate indexes
Level: WARN
Category: ✅ ACTIONABLE WARNING

Description:
  Two indexes with identical columns exist on same table.
  Wastes storage and slows down writes.

Impact:
  - Low query impact (one index is used)
  - Wastes disk space
  - Slows INSERT/UPDATE/DELETE operations

Tables Affected:
  1. fulfillment_tracking: idx_fulfillment_tracking_event vs idx_fulfillment_tracking_event_type
  2. job_customer_incidents: idx_incidents_status vs idx_job_incidents_status
  3. job_time_extension_requests: idx_job_time_ext_status vs idx_time_extensions_status
  4. notification_preferences: idx_notification_preferences_user vs idx_notification_preferences_user_id
  5. payout_schedules: idx_payout_schedules_payout_status vs idx_payout_schedules_status
  6. price_adjustments: idx_price_adj_status vs idx_price_adjustments_status

Fix:
  Drop one of each duplicate pair (keep the better-named one)

Actionable: YES
Risk: VERY LOW
Priority: MEDIUM

================================================================================
STEP 2 — IMPLEMENTATION PLAN
================================================================================

BATCH 4A: Remove Duplicate Indexes
  - Safe, immediate performance win
  - Drop 6 redundant indexes
  - Use CONCURRENTLY to avoid locks

BATCH 4B: Fix auth_rls_initplan (RLS Optimization)
  - Fix all 300+ policies
  - Replace auth.uid() with (select auth.uid())
  - High impact, zero risk
  - Group by table to keep migration readable

BATCH 4C: Consolidate Multiple Permissive Policies (OPTIONAL)
  - Case-by-case analysis required
  - Only consolidate where logic is clearly equivalent
  - Skip tables where business logic is unclear
  - Medium impact, requires careful review

================================================================================
FINDINGS NOT ACTIONABLE (if any existed)
================================================================================

None in this dataset. All findings are actionable warnings with clear fixes.

================================================================================
SUMMARY
================================================================================

Total Findings: 350+
Actionable: 350+ (100%)
High Priority: 300+ (auth_rls_initplan)
Medium Priority: 50+ (multiple policies + duplicates)

Recommended Order:
  1. BATCH 4A: Remove duplicate indexes (quick win)
  2. BATCH 4B: Fix RLS auth.uid() calls (high impact)
  3. BATCH 4C: Consolidate policies (optional, review needed)

Expected Performance Improvement:
  - 50-90% reduction in RLS policy evaluation time
  - Faster writes due to fewer indexes
  - Cleaner schema with consolidated policies
